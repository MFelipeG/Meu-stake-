<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stake Portfolio PRO</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background:#0b1220; color:#e6eef8; min-height:100vh; }
    .card { background: #0f1724; border: 1px solid #1f2a37; border-radius: 12px; padding: 16px; }
    input, select, textarea {
      background: #0f1724; color: #e6eef8; border: 1px solid #233040; padding: 8px 10px; border-radius: 8px;
    }
    ::placeholder { color:#7f8fa6; }
    .small { font-size: 0.85rem; color: #9fb0c9; }
    .muted { color:#89a0bd; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px 6px; border-bottom: 1px solid #17202a; text-align:left; }
    th { color:#cfe8ff; }
    .chip { background:#112131; padding:6px 8px; border-radius:999px; font-size:0.85rem; color:#9fd6ff; }
    .btn { background:#06b6d4; color:#072a2e; font-weight:700; padding:10px 12px; border-radius:10px; }
    .btn-ghost { background:transparent; border:1px solid #233040; color:#9fb0c9; padding:8px 10px; border-radius:8px; }
    .small-muted { font-size:0.85rem; color:#7d98b7; }
    @media (max-width: 900px) {
      .grid-2 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body class="p-6">

  <div class="max-w-[1100px] mx-auto space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-extrabold text-cyan-300">üöÄ Stake Portfolio PRO</h1>
        <div class="small-muted">Rastreamento autom√°tico com CoinGecko + gr√°ficos | Salve snapshots para hist√≥rico</div>
      </div>
      <div class="text-right small-muted">
        <div id="version">Vers√£o: PRO ¬∑ offline friendly</div>
      </div>
    </header>

    <!-- Form -->
    <section class="card">
      <form id="stakeForm" class="grid grid-cols-3 gap-4 grid-rows-auto items-end">
        <div>
          <label class="small">Plataforma</label>
          <select id="platform">
            <option>Lido</option><option>Aave</option><option>Uniswap</option><option>Binance</option><option>Outra</option>
          </select>
        </div>

        <div>
          <label class="small">Token (s√≠mbolo)</label>
          <input id="symbol" placeholder="Ex: ETH, BTC, BNB" />
          <div class="small-muted">Digite o s√≠mbolo; o site resolve o ID no CoinGecko automaticamente.</div>
        </div>

        <div>
          <label class="small">Quantidade (crypto)</label>
          <input id="amountCrypto" type="number" step="any" placeholder="Ex: 0.002" />
        </div>

        <div>
          <label class="small">Valor investido em ‚Ç¨ (opcional)</label>
          <input id="amountEuroManual" type="number" step="any" placeholder="Se deixar vazio, ser√° calculado via pre√ßo atual" />
          <div class="small-muted">Se preencher, usaremos esse valor em euros. Se deixar vazio, buscamos o pre√ßo atual.</div>
        </div>

        <div>
          <label class="small">Token Colateral (LSD) ‚Äî s√≠mbolo</label>
          <input id="lsdSymbol" placeholder="Ex: steth, aest (pode deixar vazio)" />
        </div>

        <div>
          <label class="small">Quantidade Colateral (opcional)</label>
          <input id="lsdAmount" type="number" step="any" placeholder="Ex: 0.002 (se estiver colateralizando)" />
        </div>

        <div>
          <label class="small">% de Ganho (estimado)</label>
          <input id="percentGain" type="number" step="any" placeholder="Ex: 5.5" />
        </div>

        <div>
          <label class="small">Tipo</label>
          <select id="type">
            <option value="normal">Normal</option>
            <option value="reinvest">Reinvestido (LSD)</option>
          </select>
        </div>

        <div>
          <label class="small">Carteira</label>
          <select id="wallet">
            <option>MetaMask</option><option>Trust Wallet</option><option>SafePal</option><option>Phantom</option><option>Binance Wallet</option><option>Outra</option>
          </select>
        </div>

        <div>
          <label class="small">Data de In√≠cio</label>
          <input id="startDate" type="date" />
        </div>

        <div>
          <label class="small">Tempo m√≠nimo bloqueio (dias)</label>
          <input id="minLockDays" type="number" placeholder="Ex: 30" />
        </div>

        <div>
          <label class="small">Tempo at√© desbloqueio (dias)</label>
          <input id="unlockDays" type="number" placeholder="Ex: 90" />
        </div>

        <div class="col-span-3 flex gap-2 mt-2">
          <button id="fetchAndAdd" type="button" class="btn">üîÅ Buscar pre√ßo & Adicionar</button>
          <button id="addManual" type="button" class="btn-ghost">‚ûï Adicionar manual (sem API)</button>
          <button id="saveSnapshot" type="button" class="btn-ghost">üì∏ Salvar snapshot</button>
          <div class="ml-auto small-muted self-center">Pre√ßos por CoinGecko</div>
        </div>

        <div class="col-span-3 mt-1 small-muted">Se voc√™ quer pre√ßo de uma data espec√≠fica, deixe o campo Data de In√≠cio e depois pressione <strong>Buscar pre√ßo & Adicionar</strong> (o sistema tentar√° usar pre√ßo hist√≥rico se a data for diferente de hoje).</div>
      </form>
    </section>

    <!-- Top summary -->
    <section class="card flex gap-4 flex-col md:flex-row items-stretch">
      <div class="flex-1">
        <div class="muted small">Total Investido (EUR)</div>
        <div class="text-2xl font-bold" id="totalInvested">‚Ç¨0.00</div>
      </div>
      <div class="flex-1">
        <div class="muted small">Total em Crypto (soma convertida p/‚Ç¨)</div>
        <div class="text-2xl font-bold" id="totalCryptoEuro">‚Ç¨0.00</div>
      </div>
      <div class="flex-1">
        <div class="muted small">Ganho Estimado</div>
        <div class="text-2xl font-bold text-emerald-300" id="totalGain">‚Ç¨0.00</div>
      </div>
    </section>

    <!-- Table + Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="card overflow-auto">
        <h3 class="font-semibold text-cyan-200 mb-2">Minhas Posi√ß√µes</h3>
        <table>
          <thead>
            <tr>
              <th>Plataforma</th><th>Token</th><th>Qt</th><th>‚Ç¨ atual</th><th>LSD</th><th>Bloq.</th><th>Faltam</th><th>Carteira</th><th>Ganho ‚Ç¨</th>
            </tr>
          </thead>
          <tbody id="positionsTable"></tbody>
        </table>

        <div class="mt-3 flex gap-2">
          <button id="clearAll" class="btn-ghost">Limpar tudo</button>
          <button id="exportCSV" class="btn-ghost">Exportar CSV</button>
        </div>
      </div>

      <div class="space-y-4">
        <div class="card">
          <h3 class="font-semibold text-cyan-200">Distribui√ß√£o por Plataforma</h3>
          <canvas id="pieChart" style="max-height:300px"></canvas>
        </div>

        <div class="card">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold text-cyan-200">Hist√≥rico (snapshots)</h3>
            <div class="small-muted">Salvar manualmente para criar hist√≥rico</div>
          </div>
          <canvas id="lineChart" style="max-height:220px"></canvas>
        </div>
      </div>
    </section>

    <footer class="text-center small-muted">Feito para voc√™ ‚Äî atualize, melhore e me pe√ßa novas fun√ß√µes (auto-sincronizar, alerts, etc.)</footer>
  </div>

<script>
/*
  Funcionalidades principais implementadas:
  - Buscar ID por s√≠mbolo no CoinGecko (cache local)
  - Buscar pre√ßo atual (ou hist√≥rico se data de in√≠cio fornecida)
  - Adicionar posi√ß√£o com valores em crypto + EUR
  - Suportar LSD colateral e tipo reinvestido
  - Calcular dias restantes at√© desbloqueio
  - Salvar posi√ß√µes no localStorage
  - Salvar snapshots (timestamp e total EUR) para gr√°fico hist√≥rico
  - Mostrar pie chart (distribui√ß√£o por plataforma) e line chart (hist√≥rico)
*/

// ---------- Utilit√°rios ----------
const API_BASE = 'https://api.coingecko.com/api/v3';
const cache = {
  coinList: null, // [{id,symbol,name},...]
  idMap: {}       // symbol -> id
};

function fmtMoney(n){
  return '‚Ç¨' + Number(n||0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
}

function daysBetween(dateA, dateB = new Date()){
  const diff = new Date(dateA) - new Date(dateB);
  return Math.max(0, Math.ceil(diff / (1000*60*60*24)));
}

function savePositions(positions){
  localStorage.setItem('positions_v1', JSON.stringify(positions));
}
function loadPositions(){
  try {
    return JSON.parse(localStorage.getItem('positions_v1') || '[]');
  } catch(e){ return []; }
}
function saveSnapshots(snaps){
  localStorage.setItem('snapshots_v1', JSON.stringify(snaps));
}
function loadSnapshots(){
  try {
    return JSON.parse(localStorage.getItem('snapshots_v1') || '[]');
  } catch(e){ return []; }
}

// ---------- CoinGecko helpers ----------
async function loadCoinListIfNeeded(){
  if (cache.coinList) return cache.coinList;
  const raw = localStorage.getItem('cg_coinlist_v1');
  if (raw){
    try {
      cache.coinList = JSON.parse(raw);
      return cache.coinList;
    } catch(e){}
  }
  // fetch remote (may be heavy, but we cache)
  const res = await fetch(API_BASE + '/coins/list');
  const data = await res.json();
  cache.coinList = data; // array with {id,symbol,name}
  // cache to localStorage (small size but might be large; still ok)
  try { localStorage.setItem('cg_coinlist_v1', JSON.stringify(data)); } catch(e){}
  return data;
}

async function resolveSymbolToId(symbol){
  if (!symbol) return null;
  const s = String(symbol).trim().toLowerCase();
  if (cache.idMap[s]) return cache.idMap[s];
  // try direct common cases
  await loadCoinListIfNeeded();
  const match = cache.coinList.find(c => c.symbol.toLowerCase() === s) || cache.coinList.find(c => c.id.toLowerCase() === s);
  const id = match ? match.id : null;
  cache.idMap[s] = id;
  return id;
}

async function fetchCurrentPriceEUR(id){
  if (!id) return null;
  const url = API_BASE + '/simple/price?ids=' + encodeURIComponent(id) + '&vs_currencies=eur';
  const r = await fetch(url);
  const j = await r.json();
  return j[id]?.eur ?? null;
}

async function fetchHistoricalPriceEUR(id, dateISO){
  // dateISO: yyyy-mm-dd -> CoinGecko wants dd-mm-yyyy
  if (!id || !dateISO) return null;
  const d = new Date(dateISO);
  if (isNaN(d)) return null;
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  const dateParam = dd + '-' + mm + '-' + yyyy;
  const url = API_BASE + '/coins/' + encodeURIComponent(id) + '/history?date=' + dateParam;
  const r = await fetch(url);
  if (!r.ok) return null;
  const j = await r.json();
  return j.market_data?.current_price?.eur ?? null;
}

// ---------- App state and DOM ----------
let positions = loadPositions(); // array of position objects
let snapshots = loadSnapshots(); // {ts, totalEuro}

const el = {
  form: document.getElementById('stakeForm'),
  platform: document.getElementById('platform'),
  symbol: document.getElementById('symbol'),
  amountCrypto: document.getElementById('amountCrypto'),
  amountEuroManual: document.getElementById('amountEuroManual'),
  lsdSymbol: document.getElementById('lsdSymbol'),
  lsdAmount: document.getElementById('lsdAmount'),
  percentGain: document.getElementById('percentGain'),
  type: document.getElementById('type'),
  wallet: document.getElementById('wallet'),
  startDate: document.getElementById('startDate'),
  minLockDays: document.getElementById('minLockDays'),
  unlockDays: document.getElementById('unlockDays'),

  btnFetchAdd: document.getElementById('fetchAndAdd'),
  btnAddManual: document.getElementById('addManual'),
  btnSaveSnapshot: document.getElementById('saveSnapshot'),
  btnClearAll: document.getElementById('clearAll'),
  btnExportCSV: document.getElementById('exportCSV'),

  table: document.getElementById('positionsTable'),
  totalInvested: document.getElementById('totalInvested'),
  totalCryptoEuro: document.getElementById('totalCryptoEuro'),
  totalGain: document.getElementById('totalGain'),
  pieCanvas: document.getElementById('pieChart'),
  lineCanvas: document.getElementById('lineChart')
};

// Charts
let pieChart = null;
let lineChart = null;

function initCharts(){
  const pieCtx = el.pieCanvas.getContext('2d');
  pieChart = new Chart(pieCtx, {
    type: 'pie',
    data: { labels: [], datasets:[{ data: [], backgroundColor: [] }] },
    options: { plugins:{legend:{position:'bottom'}}, maintainAspectRatio:false }
  });

  const lineCtx = el.lineCanvas.getContext('2d');
  lineChart = new Chart(lineCtx, {
    type: 'line',
    data: { labels: [], datasets:[
      { label:'Total (‚Ç¨)', data:[], borderColor:'#06b6d4', backgroundColor:'rgba(6,182,212,0.08)', tension:0.2, fill:true }
    ]},
    options:{scales:{x:{display:true}, y:{display:true}}, plugins:{legend:{display:false}}, maintainAspectRatio:false}
  });
}

function randomColor(i){
  const palette = ['#06b6d4','#10b981','#f59e0b','#ef4444','#7c3aed','#3b82f6','#f97316','#14b8a6'];
  return palette[i % palette.length];
}

// ---------- Render ----------
function renderPositions(){
  el.table.innerHTML = '';
  let totalInvested = 0;
  let totalCryptoEuro = 0;
  let totalGain = 0;
  const byPlatform = {};

  positions.forEach((p, idx) => {
    const tr = document.createElement('tr');

    // calculate remaining days
    const start = p.startDate ? new Date(p.startDate) : null;
    const unlockDate = start ? new Date(start) : null;
    if (unlockDate && p.unlockDays) unlockDate.setDate(unlockDate.getDate() + Number(p.unlockDays || 0));
    const remaining = unlockDate ? daysBetween(unlockDate) : '-';

    const currentEuro = Number(p.euroValue || 0);
    const gain = Number(p.estimatedReturn || 0) - (Number(p.manualEuro) || Number(p.euroValue || 0));
    // row cells
    tr.innerHTML = `
      <td>${p.platform}</td>
      <td>${p.symbol.toUpperCase()}</td>
      <td>${p.amountCrypto || 0}</td>
      <td>${fmtMoney(currentEuro)}</td>
      <td>${p.lsdSymbol ? (p.lsdSymbol.toUpperCase()+' '+(p.lsdAmount||'')) : '-'}</td>
      <td>${p.minLockDays? p.minLockDays+'d':'-'}</td>
      <td>${remaining}</td>
      <td>${p.wallet}</td>
      <td class="text-emerald-300">${fmtMoney(gain)}</td>
    `;
    // remove button on click
    const rem = document.createElement('td');
    rem.innerHTML = `<button class="btn-ghost">Remover</button>`;
    rem.addEventListener('click', ()=> { positions.splice(idx,1); savePositions(positions); updateAll(); });
    tr.appendChild(rem);

    el.table.appendChild(tr);

    totalInvested += Number(p.manualEuro || 0); // money out of pocket if provided manually, else 0
    totalCryptoEuro += currentEuro;
    totalGain += gain;

    byPlatform[p.platform] = (byPlatform[p.platform] || 0) + currentEuro;
  });

  el.totalInvested.textContent = fmtMoney(totalInvested);
  el.totalCryptoEuro.textContent = fmtMoney(totalCryptoEuro);
  el.totalGain.textContent = fmtMoney(totalGain);

  // update pie chart
  const labels = Object.keys(byPlatform);
  const data = labels.map(l => Math.round(byPlatform[l]*100)/100);
  const colors = labels.map((_,i)=>randomColor(i));
  pieChart.data.labels = labels;
  pieChart.data.datasets[0].data = data;
  pieChart.data.datasets[0].backgroundColor = colors;
  pieChart.update();
}

// ---------- Snapshots (history) ----------
function updateLineChart(){
  const snaps = loadSnapshots();
  lineChart.data.labels = snaps.map(s => (new Date(s.ts)).toLocaleString());
  lineChart.data.datasets[0].data = snaps.map(s => s.total);
  lineChart.update();
}

// ---------- Add position (main flow) ----------
async function addPositionFromForm(useAPI=true){
  const platform = el.platform.value;
  const symbol = String(el.symbol.value||'').trim();
  const amountCrypto = Number(el.amountCrypto.value || 0);
  const manualEuro = el.amountEuroManual.value ? Number(el.amountEuroManual.value) : null;
  const lsdSymbol = String(el.lsdSymbol.value||'').trim();
  const lsdAmount = el.lsdAmount.value ? Number(el.lsdAmount.value) : null;
  const percentGain = el.percentGain.value ? Number(el.percentGain.value) : 0;
  const type = el.type.value;
  const wallet = el.wallet.value;
  const startDate = el.startDate.value || null;
  const minLockDays = el.minLockDays.value ? Number(el.minLockDays.value) : null;
  const unlockDays = el.unlockDays.value ? Number(el.unlockDays.value) : null;

  if (!symbol || !amountCrypto){
    alert('Preencha ao menos o s√≠mbolo do token e a quantidade em crypto.');
    return;
  }

  // Determine euro value
  let euroValue = 0;
  let estimatedReturn = 0;

  if (manualEuro !== null && !isNaN(manualEuro)){
    euroValue = manualEuro;
  } else if (useAPI){
    // resolve id
    const id = await resolveSymbolToId(symbol);
    if (!id){
      if (!confirm('N√£o encontrei o ID da moeda no CoinGecko para o s√≠mbolo "'+symbol+'". Deseja adicionar a posi√ß√£o sem pre√ßo (manual)?')) return;
    } else {
      // if startDate is provided and not today, try historical
      let priceEUR = null;
      if (startDate){
        priceEUR = await fetchHistoricalPriceEUR(id, startDate).catch(()=>null);
      }
      if (priceEUR === null){
        priceEUR = await fetchCurrentPriceEUR(id).catch(()=>null);
      }
      euroValue = (priceEUR !== null) ? (priceEUR * amountCrypto) : 0;
    }
  }

  // If we have LSD amount and symbol and user didn't provide manual euro for it, try fetch LSD price (non-blocking)
  let lsdEuroValue = 0;
  if (lsdSymbol && lsdAmount){
    const lsdId = await resolveSymbolToId(lsdSymbol);
    if (lsdId){
      const lsdPrice = await fetchCurrentPriceEUR(lsdId).catch(()=>null);
      if (lsdPrice) lsdEuroValue = lsdPrice * lsdAmount;
    }
  }

  // estimatedReturn: simple model = invested + invested * percentGain/100
  estimatedReturn = euroValue + (euroValue * (percentGain/100 || 0));

  // store position
  const pos = {
    id: Date.now().toString(36),
    platform, symbol: symbol.toLowerCase(), amountCrypto, euroValue: Number(euroValue), manualEuro: manualEuro || null,
    lsdSymbol: lsdSymbol ? lsdSymbol.toLowerCase() : null, lsdAmount: lsdAmount || null, lsdEuroValue: lsdEuroValue,
    percentGain, type, wallet, startDate, minLockDays, unlockDays, estimatedReturn: Number(estimatedReturn)
  };

  positions.unshift(pos);
  savePositions(positions);
  updateAll();
  el.form.reset();
}

// ---------- CSV export ----------
function exportCSV(){
  const rows = [['id','platform','symbol','amountCrypto','euroValue','manualEuro','lsdSymbol','lsdAmount','percentGain','type','wallet','startDate','minLockDays','unlockDays','estimatedReturn']];
  positions.forEach(p => {
    rows.push([p.id,p.platform,p.symbol,p.amountCrypto,p.euroValue,p.manualEuro,p.lsdSymbol,p.lsdAmount,p.percentGain,p.type,p.wallet,p.startDate,p.minLockDays,p.unlockDays,p.estimatedReturn]);
  });
  const csv = rows.map(r => r.map(c => '"' + String(c||'').replace(/"/g,'""') + '"').join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'positions.csv'; a.click();
  URL.revokeObjectURL(url);
}

// ---------- Clear all ----------
function clearAllPositions(){
  if (!confirm('Limpar todas as posi√ß√µes?')) return;
  positions = [];
  savePositions(positions);
  updateAll();
}

// ---------- Snapshots ----------
function saveSnapshot(){
  const total = positions.reduce((s,p)=> s + Number(p.euroValue || 0), 0);
  const snaps = loadSnapshots();
  snaps.push({ ts: Date.now(), total: Math.round(total*100)/100 });
  saveSnapshots(snaps);
  updateLineChart();
  alert('Snapshot salvo.');
}

// ---------- Update everything ----------
function updateAll(){
  renderPositions();
  updateLineChart();
  // persist
  savePositions(positions);
}

// ---------- Events ----------
el.btnFetchAdd.addEventListener('click', ()=> addPositionFromForm(true));
el.btnAddManual.addEventListener('click', ()=> addPositionFromForm(false));
el.btnSaveSnapshot.addEventListener('click', saveSnapshot);
el.btnClearAll.addEventListener('click', clearAllPositions);
el.btnExportCSV.addEventListener('click', exportCSV);

// init
initCharts();
updateAll();
updateLineChart();

</script>
</body>
</html>
